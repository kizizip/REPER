# í”„ë¡œì íŠ¸ Java ë²„ì „ì— ë§ëŠ” openjdk ì´ë¯¸ì§€ ì„¤ì •
FROM openjdk:17-jdk-slim

# DB Dependencies ì„¤ì • (mariadbì™€ mysql-clientì€ ê°™ì€ê²ƒ...)
RUN apt-get update && apt-get install -y mariadb-client && rm -rf /var/lib/apt/lists/*

# Jaso Analyzer í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€ (í•„ìš”í•œ ê²½ìš°)
# Jaso Analyzer í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€ (ì •í™•í•œ ê²½ë¡œë¡œ ìˆ˜ì •)
COPY /home/ubuntu/docker/jaso-analyzer /usr/share/elasticsearch/plugins/jaso-analyzer
RUN ls -la /usr/share/elasticsearch/plugins/jaso-analyzer

# gradle ë¹Œë“œë¥¼ í•˜ë©´ build/libs í•˜ìœ„ì— *.jar ìƒì„±ë¨. í•´ë‹¹ '*.jar'ë¥¼ 'app.jar'ë¡œ copy
ARG JAR_FILE_PATH=build/libs/*.jar
COPY ${JAR_FILE_PATH} app.jar

# .yaml local/prod í”„ë¡œí•„ ë¶„ë¦¬ êµ¬ì¡°ì¼ë•Œ ì‹¤í–‰í•  í”„ë¡œí•„ ì§€ì • prod(=ìš´ì˜)
ENV USE_PROFILE prod

# ğŸ”¥ Firebase JSONì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬í•˜ì—¬ íŒŒì¼ì„ ì €ì¥í•˜ì§€ ì•ŠìŒ
# ğŸ”¥ Jenkins Pipelineì—ì„œ ENV FIREBASE_JSON ê°’ì„ ì£¼ì…í•˜ë„ë¡ ë³€ê²½
ENV FIREBASE_JSON=""

# ì‹¤í–‰ ì „ Jaso Analyzer í”ŒëŸ¬ê·¸ì¸ì´ ì—†ìœ¼ë©´ ë³µì‚¬
RUN if [ ! -d /usr/share/elasticsearch/plugins/jaso-analyzer ]; then \
      mkdir -p /usr/share/elasticsearch/plugins/jaso-analyzer; \
      cp -r /app/docker/jaso-analyzer/* /usr/share/elasticsearch/plugins/jaso-analyzer; \
    fi

# ì´ë¯¸ì§€ ë¹Œë“œ ëª…ë ¹
ENTRYPOINT ["java", "-Dspring.profiles.active=${USE_PROFILE}", "-jar", "app.jar"]
